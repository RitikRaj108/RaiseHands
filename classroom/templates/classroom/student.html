<!--
RaiseHand Lite - Student Interface

This is the student-facing page where students can:
1. Raise their hand with a big animated button
2. See their current status
3. Get notified when teacher acknowledges
4. Chat with teacher and other students

WebSocket Connection:
- Connects to ws://host/ws/classroom/<room_name>/
- Sends: {"type": "raise_hand", "student": "name"}
- Sends: {"type": "send_message", "message": "text", "sender": "name"}
- Receives: {"type": "hand_acknowledged", "student": "name"}
- Receives: {"type": "chat_message", "message": "text", "sender": "name"}
-->
{% extends 'classroom/base.html' %}

{% block title %}Student - {{ room_name }} | RaiseHand Lite{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header -->
    <header class="glass-card border-b border-white/10 px-6 py-4">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center gap-4">
                <!-- Back to home -->
                <a href="/" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>

                <div>
                    <h1 class="font-semibold">
                        <span class="text-gray-400">Room:</span>
                        <span class="text-white">{{ room_name }}</span>
                    </h1>
                    <p class="text-sm text-gray-400" id="studentName">{{ student_name|default:"Student" }}</p>
                </div>
            </div>

            <!-- Connection Status -->
            <div class="flex items-center gap-2">
                <div id="connection-status" class="w-3 h-3 bg-amber-400 rounded-full animate-pulse"></div>
                <span id="connection-text" class="text-sm text-gray-400">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Content - Split View -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Side - Raise Hand -->
        <div class="flex-1 flex flex-col items-center justify-center px-4 border-r border-white/10">
            <!-- Status Card -->
            <div id="statusCard" class="glass-card rounded-2xl p-6 text-center mb-6 w-full max-w-xs animate-fade-in">
                <div id="statusIcon"
                    class="w-16 h-16 mx-auto mb-3 rounded-full bg-gray-700/50 flex items-center justify-center transition-all duration-500">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11">
                        </path>
                    </svg>
                </div>
                <h2 id="statusText" class="text-lg font-semibold text-gray-300">Hand Down</h2>
                <p id="statusSubtext" class="text-xs text-gray-500 mt-1">Click button to raise hand</p>
            </div>

            <!-- Raise Hand Button -->
            <button id="raiseHandBtn" onclick="toggleHand()"
                class="group relative w-36 h-36 rounded-full transition-all duration-500 transform hover:scale-105 active:scale-95 focus:outline-none">
                <!-- Outer glow ring -->
                <div id="btnGlow"
                    class="absolute inset-0 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 opacity-0 blur-xl transition-opacity duration-500">
                </div>

                <!-- Button background -->
                <div id="btnBg"
                    class="absolute inset-2 rounded-full bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 shadow-2xl transition-all duration-500 flex items-center justify-center">
                    <!-- Hand icon -->
                    <svg id="btnIcon" class="w-14 h-14 text-white transition-all duration-300" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11">
                        </path>
                    </svg>
                </div>

                <!-- Ripple effect container -->
                <div id="rippleContainer" class="absolute inset-0 rounded-full overflow-hidden pointer-events-none">
                </div>
            </button>

            <!-- Button Label -->
            <p id="btnLabel" class="mt-4 text-sm font-medium text-gray-300 animate-pulse">
                Tap to Raise Hand ✋
            </p>
        </div>

        <!-- Right Side - Chat -->
        <div class="w-96 flex flex-col bg-black/20">
            <!-- Chat Header -->
            <div class="px-4 py-3 border-b border-white/10 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                    </path>
                </svg>
                <h3 class="font-semibold text-white">Class Chat</h3>
                <span id="messageCount" class="ml-auto text-xs text-gray-500">0 messages</span>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Welcome message -->
                <div class="text-center text-xs text-gray-500 py-2">
                    Welcome to the classroom! Send a message to participate.
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 border-t border-white/10">
                <form id="chatForm" onsubmit="sendMessage(event)" class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off"
                        class="flex-1 px-4 py-2 bg-white/5 border border-white/10 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 placeholder-gray-500 text-white text-sm">
                    <button type="submit"
                        class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-xl font-medium text-white text-sm transition-all duration-200 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ==========================================================================
    // WebSocket Connection and State Management
    // ==========================================================================

    // Room and student configuration from Django template
    const roomName = "{{ room_name }}";
    const studentName = "{{ student_name|default:'Anonymous' }}" || "Student_" + Math.random().toString(36).substr(2, 5);

    // Application state
    let handRaised = false;
    let socket = null;
    let reconnectAttempts = 0;
    let messageCount = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;

    // Initialize student name display
    document.getElementById('studentName').textContent = studentName;

    // ==========================================================================
    // WebSocket Connection
    // ==========================================================================

    function connectWebSocket() {
        // Construct WebSocket URL
        // Use wss:// for HTTPS, ws:// for HTTP
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/classroom/${roomName}/?username=${encodeURIComponent(studentName)}&type=student`;

        console.log('Connecting to WebSocket:', wsUrl);
        updateConnectionStatus('connecting');

        // Create WebSocket connection
        socket = new WebSocket(wsUrl);

        // Connection opened
        socket.onopen = function (e) {
            console.log('WebSocket connected');
            updateConnectionStatus('connected');
            reconnectAttempts = 0;
            showToast('Connected to classroom', 'success');
        };

        // Listen for messages
        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log('Message received:', data);

            handleMessage(data);
        };

        // Connection closed
        socket.onclose = function (e) {
            console.log('WebSocket disconnected:', e.code, e.reason);
            updateConnectionStatus('disconnected');

            // Attempt to reconnect
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms...`);
                showToast(`Reconnecting... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, 'warning');
                setTimeout(connectWebSocket, delay);
            } else {
                showToast('Connection lost. Please refresh the page.', 'error');
            }
        };

        // Handle errors
        socket.onerror = function (e) {
            console.error('WebSocket error:', e);
            showToast('Connection error', 'error');
        };
    }

    // ==========================================================================
    // Message Handling
    // ==========================================================================

    function handleMessage(data) {
        switch (data.type) {
            case 'connection_established':
                console.log('Connected as:', data.username);
                break;

            case 'hand_raised':
                // Only update if it's our own hand
                if (data.student === studentName) {
                    handRaised = true;
                    updateUI();
                }
                break;

            case 'hand_acknowledged':
                // Teacher acknowledged our hand
                if (data.student === studentName) {
                    handRaised = false;
                    updateUI();
                    showToast(`Teacher ${data.acknowledged_by || ''} acknowledged your hand! ✓`, 'success');

                    // Add a nice celebration effect
                    celebrateAcknowledgment();
                }
                break;

            case 'hand_lowered':
                if (data.student === studentName) {
                    handRaised = false;
                    updateUI();
                }
                break;

            case 'chat_message':
                // Display chat message
                addChatMessage(data.sender, data.message, data.sender_type, data.sender === studentName);
                break;

            case 'pong':
                console.log('Pong received');
                break;

            case 'error':
                showToast(data.message, 'error');
                break;
        }
    }

    // ==========================================================================
    // Chat Functions
    // ==========================================================================

    function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        if (!socket || socket.readyState !== WebSocket.OPEN) {
            showToast('Not connected to server', 'error');
            return;
        }

        // Send message to server
        socket.send(JSON.stringify({
            type: 'send_message',
            message: message,
            sender: studentName,
            sender_type: 'student'
        }));

        // Clear input
        input.value = '';
    }

    function addChatMessage(sender, message, senderType, isOwn) {
        const container = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');

        const isTeacher = senderType === 'teacher';

        messageEl.className = `animate-slide-up ${isOwn ? 'ml-8' : 'mr-8'}`;
        messageEl.innerHTML = `
            <div class="flex items-start gap-2 ${isOwn ? 'flex-row-reverse' : ''}">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0 ${isTeacher ? 'bg-gradient-to-br from-purple-500 to-pink-500' : 'bg-gradient-to-br from-indigo-500 to-blue-500'} text-white">
                    ${sender.charAt(0).toUpperCase()}
                </div>
                <div class="${isOwn ? 'bg-indigo-600/50' : isTeacher ? 'bg-purple-600/30 border border-purple-500/30' : 'bg-white/5'} rounded-xl px-3 py-2 max-w-[200px]">
                    <div class="flex items-center gap-1 mb-1">
                        <span class="text-xs font-medium ${isTeacher ? 'text-purple-300' : 'text-gray-400'}">${escapeHtml(sender)}</span>
                        ${isTeacher ? '<span class="text-[10px] bg-purple-500/30 text-purple-300 px-1.5 py-0.5 rounded">Teacher</span>' : ''}
                    </div>
                    <p class="text-sm text-white break-words">${escapeHtml(message)}</p>
                </div>
            </div>
        `;

        container.appendChild(messageEl);
        container.scrollTop = container.scrollHeight;

        // Update message count
        messageCount++;
        document.getElementById('messageCount').textContent = `${messageCount} messages`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==========================================================================
    // UI Functions
    // ==========================================================================

    function toggleHand() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            showToast('Not connected to server', 'error');
            return;
        }

        // Toggle state
        handRaised = !handRaised;

        // Send message to server
        const message = {
            type: handRaised ? 'raise_hand' : 'lower_hand',
            student: studentName
        };

        socket.send(JSON.stringify(message));

        // Update UI immediately for responsiveness
        updateUI();

        // Create ripple effect
        createRipple();
    }

    function updateUI() {
        const statusCard = document.getElementById('statusCard');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const statusSubtext = document.getElementById('statusSubtext');
        const btnGlow = document.getElementById('btnGlow');
        const btnBg = document.getElementById('btnBg');
        const btnLabel = document.getElementById('btnLabel');

        if (handRaised) {
            // Hand is raised - show active state
            statusIcon.className = 'w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center transition-all duration-500 animate-bounce-gentle';
            statusIcon.innerHTML = `
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"></path>
                </svg>
            `;
            statusText.textContent = '✋ Hand Raised!';
            statusText.className = 'text-lg font-semibold text-amber-400';
            statusSubtext.textContent = 'Waiting for teacher...';

            btnGlow.classList.add('opacity-100');
            btnBg.className = 'absolute inset-2 rounded-full bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 shadow-2xl transition-all duration-500 flex items-center justify-center animate-glow';
            btnLabel.textContent = 'Tap to Lower';
            btnLabel.className = 'mt-4 text-sm font-medium text-amber-300';
        } else {
            // Hand is down - show default state
            statusIcon.className = 'w-16 h-16 mx-auto mb-3 rounded-full bg-gray-700/50 flex items-center justify-center transition-all duration-500';
            statusIcon.innerHTML = `
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"></path>
                </svg>
            `;
            statusText.textContent = 'Hand Down';
            statusText.className = 'text-lg font-semibold text-gray-300';
            statusSubtext.textContent = 'Click button to raise hand';

            btnGlow.classList.remove('opacity-100');
            btnBg.className = 'absolute inset-2 rounded-full bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-700 shadow-2xl transition-all duration-500 flex items-center justify-center';
            btnLabel.textContent = 'Tap to Raise Hand ✋';
            btnLabel.className = 'mt-4 text-sm font-medium text-gray-300 animate-pulse';
        }
    }

    function updateConnectionStatus(status) {
        const indicator = document.getElementById('connection-status');
        const text = document.getElementById('connection-text');

        if (status === 'connected') {
            indicator.className = 'w-3 h-3 bg-emerald-400 rounded-full';
            text.textContent = 'Connected';
            text.className = 'text-sm text-emerald-400';
        } else if (status === 'connecting') {
            indicator.className = 'w-3 h-3 bg-amber-400 rounded-full animate-pulse';
            text.textContent = 'Connecting...';
            text.className = 'text-sm text-amber-400';
        } else {
            indicator.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
            text.textContent = 'Disconnected';
            text.className = 'text-sm text-red-400';
        }
    }

    function createRipple() {
        const container = document.getElementById('rippleContainer');
        const ripple = document.createElement('div');
        ripple.className = 'absolute inset-0 bg-white/20 rounded-full scale-0 animate-ping';
        container.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    }

    function celebrateAcknowledgment() {
        // Add a celebration effect when acknowledged
        const card = document.getElementById('statusCard');
        card.classList.add('ring-4', 'ring-emerald-400/50');
        setTimeout(() => {
            card.classList.remove('ring-4', 'ring-emerald-400/50');
        }, 2000);
    }

    // ==========================================================================
    // Initialization
    // ==========================================================================

    // Connect when page loads
    document.addEventListener('DOMContentLoaded', function () {
        connectWebSocket();

        // Keep-alive ping every 30 seconds
        setInterval(() => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);
    });

    // Warn before leaving if hand is raised
    window.addEventListener('beforeunload', function (e) {
        if (handRaised) {
            e.preventDefault();
            e.returnValue = 'Your hand is still raised. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
</script>
{% endblock %}